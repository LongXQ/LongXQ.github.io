<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> RRedis Intset实现 · oooo</title><meta name="description" content="RRedis Intset实现 - 龙雄球"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://longxq.github.io/atom.xml" title="oooo"></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/LongXQ" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xm" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">RRedis Intset实现</h1><div class="post-info">Jul 7, 2018</div><div class="post-content"><p>Redis Intset结构是用来实现REDIS_ENCODING_INTSET对象编码的。当一个Redis<br>set对象中所有的元素都是整数的时候适合用REDIS_ENCODING_INTSET对象编码来存储。<br>不同于数组，Intset能够存储不同字节长度的整数，并且是按照有序的方式存到intset结构中来的。</p>
<a id="more"></a>
<h3 id="Intset结构"><a href="#Intset结构" class="headerlink" title="Intset结构"></a>Intset结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span>&#123;</span>  </span><br><span class="line">	<span class="keyword">uint32_t</span> encoding;  </span><br><span class="line">	<span class="keyword">uint32_t</span> length;  </span><br><span class="line">	<span class="keyword">int8_t</span> contents[];  </span><br><span class="line">&#125;intset;</span><br></pre></td></tr></table></figure>
<ol>
<li>length字段表示目前intset结构中有多少个元素。  </li>
<li>contents为占位符，代表元素的起始地址。  </li>
<li>Intset结构中的encoding字段可以有以下的取值:   </li>
</ol>
<pre><code class="c"><span class="meta">#<span class="meta-keyword">define</span> INTSET_ENC_INT16 (sizeof(int16_t))  </span>
<span class="meta">#<span class="meta-keyword">define</span> INTSET_ENC_INT32 (sizeof(int32_t))  </span>
<span class="meta">#<span class="meta-keyword">define</span> INTSET_ENC_INT64 (sizeof(int64_t)) </span>
</code></pre>
<ol>
<li>INTSET_ENC_INT16表示当前intset结构中的元素按照16位的整数来存储的</li>
<li>INTSET_ENC_INT32表示当前intset结构中的元素按照32位的整数来存储的</li>
<li>INTSET_ENC_INT64表示当前intset结构中的元素按照64位的整数来存储的</li>
</ol>
<p>特别注意的是，encoding字段取值只能前进不能倒退，意思就是如果如果当前encoding字段的值是INTSET_ENC_INT32，那么就不能在给encoding赋值为INTSET_ENC_INT16了，只能保持不变或者赋值为INTSET_ENC_INT64。</p>
<h3 id="新建一个Intset结构"><a href="#新建一个Intset结构" class="headerlink" title="新建一个Intset结构"></a>新建一个Intset结构</h3><p>新建一个Intset结构时，默认的encoding字段设置为INTSET_ENC_INT16，表示当前intset结构中的整数按照16位整数来进行存取，初始的时候长度为0所以length字段设置为0 </p>
<p><img src="/images/emptyintset.png" alt="empty intset"></p>
<h3 id="Intset元素插入"><a href="#Intset元素插入" class="headerlink" title="Intset元素插入"></a>Intset元素插入</h3><p>当插入一个整数的时候，首先intset会检查该整数的最小编码方式，看最小能够用多少个字节来存储这个整数，如果能够用2个字节来存储这个整数，则这个整数的最小编码就是INTSET_ENC_INT16，如果要用4个字节来存储，最小编码就是INTSET_ENC_INT32，如果要用8个字节来存储，最小编码就是INTSET_ENC_INT64。</p>
<h3 id="插入最小编码为INTSET-ENC-INT16的整数"><a href="#插入最小编码为INTSET-ENC-INT16的整数" class="headerlink" title="插入最小编码为INTSET_ENC_INT16的整数"></a>插入最小编码为INTSET_ENC_INT16的整数</h3><p>刚开始时，encoding字段也是INTSET_ENC_INT16，所以intset会按照encoding的方式来存储这个整数。<br>首先在intset中查找当前整数是否已经在intset中了，如果已经存在则不插入，如果不存在则分配两个字节的空间给新元素，找到插入点，然后插入进去。由于刚开始时，intset为空，所以直接插入到第一个位置。</p>
<p><img src="/images/INTSET_ENC_INT16.png" alt="INTSET_ENC_INT16">  </p>
<p>我们在插入一个INTSET_ENC_INT16的整数。首先调整intset的大小，新分配两个字节的空间，在找到待插入点，假设当前元素比intset中存在的元素小，那么应该把待插入的元素插入到起始位置，所以首先要进行数据移位，然后再插入。 </p>
<p><img src="/images/INTSET_ENC_INT16_1.png" alt="INTSET_ENC_INT16"></p>
<h3 id="插入一个最小编码为INTSET-ENC-INT32的整数"><a href="#插入一个最小编码为INTSET-ENC-INT32的整数" class="headerlink" title="插入一个最小编码为INTSET_ENC_INT32的整数"></a>插入一个最小编码为INTSET_ENC_INT32的整数</h3><p>因为插入的元素要用4个字节存储，如果还是按照原先的encoding方式进行内存分配和移动位置的话，显然覆盖掉原先的元素。<br>首先intset把encoding赋值为新值INTSET_ENC_32。然后把以前旧的元素的最小编码进行提升，也就是通通改成INTSET_ENC_INT32的编码方式，用4个字节进行存储。所以接下来就是调整数据空间的大小，因为当前intset中已经有2个元素了，占用了4个字节，最小编码提升后，由于每一个元素要占用4个字节，所以旧元素总共要新增4个字节，在加上新插入的元素总共要增加8个字节的空间。</p>
<p><img src="/images/INTSET_ENC_INT32.png" alt="INTSET_ENC_INT32"> </p>
<p>由于新插入的元素要么比当前intset中的元素都要大，要么都要小(因为当前intset中的元素以前都是INTSET_ENC_16编码的，也就是2个字节的整数，所以当前插入的元素是4个字节整数的，要么比当前intset中的元素都大，要么都要小(负数))，所以要么是插入到头部，要么是插入到尾部，假设插入的元素比当前intset中的元素都要小，所以插入到头部。</p>
<p><img src="/images/INTSET_ENC_INT32_1.png" alt="INTSET_ENC_INT32">  </p>
<p>如果后续插入编码方式为INTSET_ENC_INT16的整数，那么由于当前encoding为INTSET_ENC_INT32，所以要按照encoidng的方式插入整数。如果后续插入的是INTSET_ENC_INT64的整数，则按照前面的方法一样。<br>至于从intset中删除元素，则很简单了，按照当前encoding的方式删除元素即可。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/07/redisdb/" class="prev">PREV</a><a href="/2018/07/07/redis_dict/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'longxq-github-io';
var disqus_identifier = '2018/07/07/redis_intset/';
var disqus_title = 'RRedis Intset实现';
var disqus_url = 'https://longxq.github.io/2018/07/07/redis_intset/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//longxq-github-io.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="https://longxq.github.io">龙雄球</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>